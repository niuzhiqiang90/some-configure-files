#!/bin/bash
################################################################################
#          FILE: mongo-svc
#         USAGE: 
#   DESCRIPTION: 
#       OPTIONS: --- 
#          BUGS: --- 
#         NOTES: --- 
#        AUTHOR: niuzhiqiang, niuzhiqiang90@foxmail.com
#  ORGANIZATION: 
#       CREATED: Sat 09 Sep 2017 12:31:34 AM CST
#      REVISION: 1.0.0
################################################################################

declare -r mongod_home="/usr/local/bin/mongod"
declare -r mongod_bin="./bin/mongod"
declare -r mongod_conf="./conf/mongod.conf"
declare -r mongod_log="./logs/mongod.log"
declare -r mongod_log_dir=$(dirname $mongod_log)

function start_mongod()
{
	echo "Starting mongod ..."
    pushd ${mongod_home} > /dev/null
    [[ ! -d ${mongod_log_dir} ]] && /bin/mkdir ${mongod_log_dir} && /usr/bin/touch ${mongod_log}
    ${mongod_bin} --config ${mongod_conf} 2>&1 >> $log &
	[ $? -eq 0 ] && echo "ok" || echo "failed"
    popd > /dev/null
}

function get_mongod_pid()
{
    local mongod_pid=$(ps -ef | grep ${mongod_bin} | grep -v grep | awk '{print $2}')
    if [[ ${mongod_pid} -ne 0 ]]; then
        return ${mongod_pid}
    fi
    return 0
}

function stop_mongod()
{
    pushd ${mongod_home} > /dev/null
    local mongod_pid=get_mongod_pid
    if [[ ${mongod_pid} -ne 0 ]]; then
	    echo "Stopping mongod ..."
        /bin/kill ${mongod_pid}
	    [[ $? -eq 0 ]] && echo "ok" || echo "failed" 
    else
        echo "mongod is not running ..."
    fi
    popd > /dev/null
}


function get_mongod_status()
{
    local mongod_pid=get_mongod_pid
    if [[ ${mongod_pid} -ne 0 ]]; then
        echo "mongod is running ..."
    else
        echo "mongod is stopped ..."
    fi
}

function view_log()
{
    /usr/bin/tail -f ${mongod_log}
}

function print_usage()
{
    echo "Usage: $0 {start|stop|restart|status|tail}"
    exit 1
}

function main()
{
    [[ $# -ne 1 ]] && print_usage
    case "$1" in
    	start)
    		start_mongod
    		;;
    	stop)
    		stop_mongod
    		;;
    	restart)
    		stop_mongod
    		start_mongod
    		;;
        status)
            get_mongod_status
            ;;
        tail)
            view_log
            ;;
    	*)
            print_usage
    esac
}

main $@
